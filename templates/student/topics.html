{% extends 'student/base.html' %}

{% block title %}Course Topics{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Course: {{ course.title }}</h3>
        <a href="/student/courses" class="btn btn-sm btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Course
        </a>
    </div>

    {% if topics %}
        {% for topic in topics %}
        <div class="card shadow mt-3">
            <div class="card-header bg-success text-white">
                Topic {{ topic.topic_no }}
            </div>
            <div class="card-body">
                <figure>
                    <blockquote class="blockquote">
                        <div class="d-flex justify-content-between align-items-center">
                            <p class="mb-0">{{ topic.title }}</p>
                            <div>
                                <div>
                                    <a href="{{ url_for('topic_file_view', topic_id=topic.id) }}" target="_blank"
                                        class="btn btn-info me-2 text-white">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    <a href="{{ url_for('download_topic_file', topic_id=topic.id) }}" class="btn btn-secondary"
                                        style="background-color: gray;">
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </blockquote>
                    <figcaption class="blockquote-footer">
                        {{ topic.subtitle }}
                    </figcaption>
                </figure>
            </div>
        </div>

        <div class="card shadow mt-2 mb-4">
            <div class="card-header bg-primary text-white">
                Assessment for Topic {{ topic.topic_no }} <i class="bi bi-patch-question float-end"></i>
            </div>
            <div class="card-body d-flex justify-content-between align-items-center">
                <p class="text-muted mb-0">Test your understanding of this topic.</p>

                {% if topic.question_count and topic.question_count > 0 %}
                <!-- Start Quiz Button triggers modal -->
                <button class="btn quiz-btn btn-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#quizStartModal{{ topic.id }}">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Start Topic Quiz
                </button>
                {% else %}
                <span class="text-warning">No generated quiz available yet.</span>
                {% endif %}
            </div>
        </div>

        {% if topic.question_count and topic.question_count > 0 %}
        <!-- Modal for this topic -->
        <div class="modal fade" id="quizStartModal{{ topic.id }}" tabindex="-1" aria-labelledby="quizStartModalLabel{{ topic.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content ps-3 pt-3">
              <div class="modal-header">
                <h5 class="modal-title" id="quizStartModalLabel{{ topic.id }}">Quiz Instructions: {{ topic.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Please read the instructions carefully before starting the quiz:</p>
                <ul>
                  <li>- Ensure a stable internet connection.</li>
                  <li>- Do not refresh, close, or navigate away once the quiz begins.</li>
                  <li>- Each question is required; you must select one answer.</li>
                  <li>- You will be given 1 attempt.</li>
                  <li>- You have 15 minutes to finish the quiz, after 15 minutes the quiz will be submitted automatically.</li>
                  <li>- Click <strong>Start Quiz</strong> to begin.</li>
                </ul>

                {% set MAX_ATTEMPTS = 1 %}
                {% set used_attempts = student_attempts.get(topic.id, 0) %}
                {% set attempts_left = MAX_ATTEMPTS - used_attempts %}
                
                {% if attempts_left <= 0 %} <p class="text-danger fw-semibold mt-2">
                    You have already attempted this quiz.
                    </p>
                {% else %}
                    <p class="text-success fw-semibold mt-2">
                        You have 1 attempt available.
                    </p>
                {% endif %}


                <div class="form-check mt-3">
                  <input type="checkbox" class="form-check-input" id="confirmCheckModal{{ topic.id }}">
                  <label class="form-check-label" for="confirmCheckModal{{ topic.id }}">
                    I have read and understood the instructions.
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left"></i> Cancel
                </button>
                <a href="{{ url_for('get_quiz_for_student', topic_id=topic.id) }}" class="btn btn-success disabled"
                    id="startQuizBtnModal{{ topic.id }}">
                    <i class="bi bi-play-fill"></i> Start Quiz
                </a>

                </div>
            </div>
          </div>
        </div>

        {% endif %}

        {% endfor %}
    {% else %}
        <div class="alert alert-info mt-3">
            No uploaded topics for this course yet.
        </div>
    {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Select all checkboxes and start buttons
    const checkboxes = document.querySelectorAll('input[id^="confirmCheckModal"]');

    checkboxes.forEach(checkbox => {
        const topicId = checkbox.id.replace("confirmCheckModal", "");
        const startBtn = document.getElementById("startQuizBtnModal" + topicId);
        const originalText = startBtn.innerHTML; 

        // Enable/disable Start Quiz button
        checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
                startBtn.classList.remove("disabled");
            } else {
                startBtn.classList.add("disabled");
                startBtn.innerHTML = originalText; // reset button text
            }
        });

        // Countdown on click
        startBtn.addEventListener("click", (e) => {
            if (!checkbox.checked || startBtn.classList.contains("disabled")) return;
            e.preventDefault();

            let countdown = 3; // seconds
            startBtn.classList.add("disabled"); // prevent multiple clicks

            const interval = setInterval(() => {
                if (countdown > 0) {
                    startBtn.innerHTML = `<i class="bi bi-play-fill"></i> Starting in ${countdown}...`;
                    countdown--;
                } else {
                    clearInterval(interval);
                    window.location.href = startBtn.href;
                }
            }, 1000);
        });
    });
});
</script>



{% endblock %}
